# ç»„åˆäº§å“åŠŸèƒ½å®æ–½æ€»ç»“

## âœ… å®æ–½å®Œæˆæƒ…å†µ

æ‰€æœ‰ä»»åŠ¡å·²å®Œæˆï¼ŒåŠŸèƒ½å·²å®ç°ï¼ğŸ‰

### 1. æ•°æ®åº“å±‚ âœ…
- **dm_product_info è¡¨æ‰©å±•**ï¼ˆåªå¢åŠ 2ä¸ªå­—æ®µï¼‰
  - `product_type`ï¼šäº§å“ç±»å‹ï¼ˆ0=æ™®é€šäº§å“ï¼Œ1=ç»„åˆäº§å“ï¼‰
  - `bundle_type`ï¼šç»„åˆç±»å‹ï¼ˆ1=è‡ªå®šä¹‰æˆæœ¬ä»·ï¼Œ2=è‡ªåŠ¨ç´¯è®¡æˆæœ¬ä»·ï¼‰
  - `cost_price`ï¼šã€å¤ç”¨åŸæœ‰å­—æ®µã€‘å­˜å‚¨æœ€ç»ˆæˆæœ¬ä»·
  
- **dm_product_bundle_relation æ–°è¡¨**ï¼ˆç²¾ç®€ç‰ˆï¼‰
  - åªå­˜å‚¨å…³è”å…³ç³»ï¼ˆbundle_product_idã€sub_product_idã€quantityï¼‰
  - ä¸å­˜å‚¨å†—ä½™æ•°æ®ï¼Œæ‰€æœ‰å­äº§å“ä¿¡æ¯å®æ—¶ JOIN è·å–

### 2. æ•°æ®å¯¹è±¡å±‚ âœ…
- **ProductBundleRelationDO** - æ–°å»ºç»„åˆå…³ç³» DO
- **ProductInfoDO** - æ‰©å±•2ä¸ªå­—æ®µï¼ˆproductTypeã€bundleTypeï¼‰

### 3. VO å±‚ âœ…
- **ProductBundleItemReqVO** - ç»„åˆäº§å“æ˜ç»†è¯·æ±‚ VO
- **ProductBundleItemRespVO** - ç»„åˆäº§å“æ˜ç»†å“åº” VOï¼ˆåŒ…å«å®æ—¶å­äº§å“ä¿¡æ¯ï¼‰
- **ProductInfoSaveReqVO** - æ‰©å±•æ”¯æŒç»„åˆäº§å“å­—æ®µ
- **ProductInfoRespVO** - æ‰©å±•è¿”å›ç»„åˆäº§å“ä¿¡æ¯

### 4. Mapper å±‚ âœ…
- **ProductBundleRelationMapper** - æ–°å»ºå…³ç³»è¡¨ Mapper
  - `selectListByBundleProductId()` - æ ¹æ®ç»„åˆäº§å“IDæŸ¥è¯¢æ˜ç»†
  - `deleteByBundleProductId()` - åˆ é™¤ç»„åˆäº§å“å…³ç³»
  - `selectListBySubProductId()` - æ ¹æ®å­äº§å“IDæŸ¥è¯¢å…³è”å…³ç³»
  
- **ProductInfoMapper** - æ‰©å±•æŸ¥è¯¢æ–¹æ³•
  - `selectListByProductTypeAndBundleType()` - æŸ¥è¯¢æŒ‡å®šç±»å‹çš„ç»„åˆäº§å“

### 5. Service å±‚ âœ…
- **BundleProductServiceHelper** - ç»„åˆäº§å“ä¸šåŠ¡é€»è¾‘è¾…åŠ©ç±»
  - `validateBundleProduct()` - æ ¡éªŒç»„åˆäº§å“æ•°æ®
  - `createBundleRelations()` - åˆ›å»ºç»„åˆå…³ç³»
  - `calculateBundleCostPrice()` - è®¡ç®—ç»„åˆäº§å“æˆæœ¬ä»·
  - `recalculateBundleCostPrice()` - é‡æ–°è®¡ç®—æˆæœ¬ä»·ï¼ˆè‡ªåŠ¨ç´¯è®¡æ¨¡å¼ï¼‰
  - `batchRecalculateBundleCostPrice()` - æ‰¹é‡é‡æ–°è®¡ç®—

- **ProductInfoService** - æ‰©å±•æ¥å£æ–¹æ³•
  - `getBundleRelations()` - è·å–ç»„åˆäº§å“æ˜ç»†
  - `recalculateBundleCostPrice()` - é‡æ–°è®¡ç®—æˆæœ¬ä»·
  - `batchRecalculateBundleCostPrice()` - æ‰¹é‡é‡æ–°è®¡ç®—
  
- **ProductInfoServiceImpl** - å®ç°ç»„åˆäº§å“é€»è¾‘
  - æ‰©å±• `createProductInfo()` - æ”¯æŒåˆ›å»ºç»„åˆäº§å“
  - æ‰©å±• `updateProductInfo()` - æ”¯æŒæ›´æ–°ç»„åˆäº§å“
  - å®ç°ç»„åˆäº§å“æˆæœ¬ä»·è‡ªåŠ¨è®¡ç®—
  - å®ç°ç»„åˆå…³ç³»ç®¡ç†

### 6. Controller å±‚ âœ…
- **ProductInfoController** - æ–°å¢APIç«¯ç‚¹
  - `GET /bundle-relations` - è·å–ç»„åˆäº§å“æ˜ç»†åˆ—è¡¨
  - `POST /recalculate-bundle-cost` - é‡æ–°è®¡ç®—å•ä¸ªç»„åˆäº§å“æˆæœ¬ä»·
  - `POST /batch-recalculate-bundle-cost` - æ‰¹é‡é‡æ–°è®¡ç®—æ‰€æœ‰ç»„åˆäº§å“æˆæœ¬ä»·

### 7. é”™è¯¯ç  âœ…
æ–°å¢7ä¸ªç»„åˆäº§å“ç›¸å…³é”™è¯¯ç ï¼ˆ2_001_001_100 ~ 2_001_001_106ï¼‰

### 8. æµ‹è¯•æŒ‡å— âœ…
å®Œæ•´çš„æµ‹è¯•æŒ‡å—æ–‡æ¡£ï¼š`sql/dm/bundle_product_test_guide.md`

## ğŸ“ æ–‡ä»¶æ¸…å•

### æ–°å»ºæ–‡ä»¶
1. `sql/dm/bundle_product_init.sql` - æ•°æ®åº“å˜æ›´è„šæœ¬
2. `yudao-module-dm/yudao-module-dm-server/src/main/java/cn/iocoder/yudao/module/dm/dal/dataobject/product/ProductBundleRelationDO.java`
3. `yudao-module-dm/yudao-module-dm-server/src/main/java/cn/iocoder/yudao/module/dm/controller/admin/product/vo/ProductBundleItemReqVO.java`
4. `yudao-module-dm/yudao-module-dm-server/src/main/java/cn/iocoder/yudao/module/dm/controller/admin/product/vo/ProductBundleItemRespVO.java`
5. `yudao-module-dm/yudao-module-dm-server/src/main/java/cn/iocoder/yudao/module/dm/dal/mysql/product/ProductBundleRelationMapper.java`
6. `yudao-module-dm/yudao-module-dm-server/src/main/java/cn/iocoder/yudao/module/dm/service/product/BundleProductServiceHelper.java`
7. `sql/dm/bundle_product_test_guide.md` - æµ‹è¯•æŒ‡å—
8. `ç»„åˆäº§å“åŠŸèƒ½æ‰©å±•æ–¹æ¡ˆ-æœ€å°åŒ–æ”¹åŠ¨.md` - æ–¹æ¡ˆæ–‡æ¡£
9. `ç»„åˆäº§å“åŠŸèƒ½å®æ–½æ€»ç»“.md` - æœ¬æ–‡æ¡£

### ä¿®æ”¹æ–‡ä»¶
1. `yudao-module-dm/yudao-module-dm-server/src/main/java/cn/iocoder/yudao/module/dm/dal/dataobject/product/ProductInfoDO.java` - æ–°å¢2ä¸ªå­—æ®µ
2. `yudao-module-dm/yudao-module-dm-server/src/main/java/cn/iocoder/yudao/module/dm/controller/admin/product/vo/ProductInfoSaveReqVO.java` - æ‰©å±•VO
3. `yudao-module-dm/yudao-module-dm-server/src/main/java/cn/iocoder/yudao/module/dm/controller/admin/product/vo/ProductInfoRespVO.java` - æ‰©å±•VO
4. `yudao-module-dm/yudao-module-dm-server/src/main/java/cn/iocoder/yudao/module/dm/dal/mysql/product/ProductInfoMapper.java` - æ‰©å±•æŸ¥è¯¢æ–¹æ³•
5. `yudao-module-dm/yudao-module-dm-server/src/main/java/cn/iocoder/yudao/module/dm/service/product/ProductInfoService.java` - æ‰©å±•æ¥å£
6. `yudao-module-dm/yudao-module-dm-server/src/main/java/cn/iocoder/yudao/module/dm/service/product/ProductInfoServiceImpl.java` - å®ç°ç»„åˆäº§å“é€»è¾‘
7. `yudao-module-dm/yudao-module-dm-server/src/main/java/cn/iocoder/yudao/module/dm/controller/admin/product/ProductInfoController.java` - æ–°å¢API
8. `yudao-module-dm/yudao-module-dm-api/src/main/java/cn/iocoder/yudao/module/dm/enums/ErrorCodeConstants.java` - æ–°å¢é”™è¯¯ç 

## ğŸ¯ æ ¸å¿ƒè®¾è®¡äº®ç‚¹

### 1. æœ€å°åŒ–æ•°æ®åº“æ”¹åŠ¨ â­â­â­â­â­
- åŸæœ‰è¡¨åªå¢åŠ  **2ä¸ªå­—æ®µ**
- æ–°å¢ **1å¼ å…³ç³»è¡¨**ï¼ˆç²¾ç®€ç‰ˆï¼‰
- å¤ç”¨ `cost_price` å­—æ®µï¼Œé¿å…å­—æ®µå†—ä½™

### 2. å®æ—¶æ•°æ® vs å¿«ç…§æ•°æ® â­â­â­â­â­
- å…³ç³»è¡¨**ä¸å­˜å‚¨**å­äº§å“çš„å†—ä½™æ•°æ®ï¼ˆSKUã€åç§°ã€å•ä»·ç­‰ï¼‰
- æ‰€æœ‰å­äº§å“ä¿¡æ¯**å®æ—¶ JOIN** è·å–
- ä¿è¯æ•°æ®ä¸€è‡´æ€§ï¼Œé¿å…å¿«ç…§æ•°æ®è¿‡æœŸ

### 3. ä¸¤ç§æˆæœ¬ä»·æ¨¡å¼ â­â­â­â­â­
- **è‡ªå®šä¹‰æ¨¡å¼ï¼ˆbundleType=1ï¼‰**ï¼šç”¨æˆ·æ‰‹åŠ¨è®¾ç½®æˆæœ¬ä»·ï¼Œä¸éšå­äº§å“å˜åŒ–
- **è‡ªåŠ¨ç´¯è®¡æ¨¡å¼ï¼ˆbundleType=2ï¼‰**ï¼šæˆæœ¬ä»·è‡ªåŠ¨è®¡ç®—ï¼Œå¯å®šæ—¶é‡ç®—

### 4. ä¸šåŠ¡é€»è¾‘åˆ†ç¦» â­â­â­â­
- æ ¸å¿ƒé€»è¾‘å°è£…åœ¨ `BundleProductServiceHelper` ä¸­
- Service å±‚è°ƒç”¨è¾…åŠ©ç±»ï¼Œä¿æŒä»£ç æ¸…æ™°
- æ–¹ä¾¿åç»­æ‰©å±•å’Œç»´æŠ¤

## ğŸš€ ä½¿ç”¨æµç¨‹

### åˆ›å»ºç»„åˆäº§å“ï¼ˆè‡ªåŠ¨ç´¯è®¡æ¨¡å¼ï¼‰

```http
POST /admin-api/dm/product-info/create
{
  "skuId": "COMBO-001",
  "skuName": "é”…å…·3ä»¶å¥—",
  "productType": 1,
  "bundleType": 2,
  "bundleItems": [
    {"subProductId": 5, "quantity": 2},
    {"subProductId": 7, "quantity": 1}
  ]
}
```

### æŸ¥è¯¢ç»„åˆäº§å“æ˜ç»†

```http
GET /admin-api/dm/product-info/bundle-relations?bundleProductId=100
```

### å­äº§å“æˆæœ¬å˜åŒ–åé‡æ–°è®¡ç®—

```http
POST /admin-api/dm/product-info/recalculate-bundle-cost?bundleProductId=100
```

## ğŸ“Š æ•°æ®æµç¨‹å›¾

```
åˆ›å»º/æ›´æ–°ç»„åˆäº§å“
    â†“
æ ¡éªŒæ•°æ®ï¼ˆBundleProductServiceHelperï¼‰
    â†“
è®¡ç®—æˆæœ¬ä»·
    â”œâ”€ bundleType=1 â†’ ä½¿ç”¨ç”¨æˆ·è¾“å…¥çš„ costPrice
    â””â”€ bundleType=2 â†’ å®æ—¶æŸ¥è¯¢å­äº§å“ï¼Œç´¯åŠ è®¡ç®—
    â†“
ä¿å­˜äº§å“ä¿¡æ¯ï¼ˆdm_product_infoï¼‰
    â†“
ä¿å­˜ç»„åˆå…³ç³»ï¼ˆdm_product_bundle_relationï¼‰
    â†“
è¿”å›æˆåŠŸ
```

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. æ•°æ®åº“æ‰§è¡Œé¡ºåº
1. å…ˆæ‰§è¡Œ `bundle_product_init.sql` åˆå§‹åŒ–æ•°æ®åº“
2. å†å¯åŠ¨åº”ç”¨è¿›è¡Œæµ‹è¯•

### 2. æƒé™é…ç½®
æ–°å¢çš„ API éœ€è¦é…ç½®æƒé™ï¼š
- `dm:product-info:query` - æŸ¥è¯¢ç»„åˆäº§å“æ˜ç»†
- `dm:product-info:update` - é‡æ–°è®¡ç®—æˆæœ¬ä»·

### 3. æ€§èƒ½ä¼˜åŒ–å»ºè®®
- å¦‚æœç»„åˆäº§å“æ•°é‡å¾ˆå¤§ï¼Œå»ºè®®è®¾ç½®å®šæ—¶ä»»åŠ¡æ‰¹é‡é‡ç®—æˆæœ¬ä»·ï¼ˆå‡Œæ™¨æ‰§è¡Œï¼‰
- ç¡®ä¿ç´¢å¼•å·²åˆ›å»ºï¼š`idx_product_type`ã€`idx_bundle_product`

### 4. é˜²æ­¢ç»„åˆäº§å“åµŒå¥—
- ç³»ç»Ÿä¼šè‡ªåŠ¨æ ¡éªŒï¼Œé˜²æ­¢ç»„åˆäº§å“åµŒå¥—
- é”™è¯¯ç ï¼š`2_001_001_104`

## ğŸ”® åç»­æ‰©å±•å»ºè®®

### 1. å®šæ—¶ä»»åŠ¡
å¯ä»¥æ·»åŠ å®šæ—¶ä»»åŠ¡ï¼Œæ¯å¤©è‡ªåŠ¨é‡ç®—æ‰€æœ‰è‡ªåŠ¨ç´¯è®¡æ¨¡å¼çš„ç»„åˆäº§å“æˆæœ¬ä»·ï¼š

```java
@Scheduled(cron = "0 0 2 * * ?")
public void scheduledRecalculate() {
    productInfoService.batchRecalculateBundleCostPrice();
}
```

### 2. å­äº§å“å˜åŒ–ç›‘å¬
å¦‚æœéœ€è¦å®æ—¶æ›´æ–°ï¼Œå¯ä»¥è€ƒè™‘ï¼š
- ç›‘å¬å­äº§å“æˆæœ¬ä»·å˜åŒ–äº‹ä»¶
- è‡ªåŠ¨è§¦å‘ç»„åˆäº§å“æˆæœ¬ä»·é‡ç®—

### 3. å‰ç«¯æ”¯æŒ
å‰ç«¯éœ€è¦ï¼š
- ç»„åˆäº§å“åˆ›å»º/ç¼–è¾‘è¡¨å•
- å­äº§å“é€‰æ‹©å™¨
- æˆæœ¬ä»·è®¡ç®—æ¨¡å¼åˆ‡æ¢
- æ˜ç»†åˆ—è¡¨å±•ç¤º

### 4. æŠ¥è¡¨ç»Ÿè®¡
å¯ä»¥æ‰©å±•ï¼š
- ç»„åˆäº§å“æˆæœ¬ä»·å˜åŒ–è¶‹åŠ¿
- å­äº§å“åœ¨ç»„åˆä¸­çš„ä½¿ç”¨æƒ…å†µç»Ÿè®¡

## ğŸ“ æµ‹è¯•æ¸…å•

è¯·å‚è€ƒ `sql/dm/bundle_product_test_guide.md` è¿›è¡Œå®Œæ•´æµ‹è¯•ã€‚

ä¸»è¦æµ‹è¯•ç‚¹ï¼š
- âœ… åˆ›å»ºè‡ªå®šä¹‰æˆæœ¬ä»·ç»„åˆäº§å“
- âœ… åˆ›å»ºè‡ªåŠ¨ç´¯è®¡æˆæœ¬ä»·ç»„åˆäº§å“
- âœ… æŸ¥è¯¢ç»„åˆäº§å“æ˜ç»†
- âœ… æ›´æ–°ç»„åˆäº§å“
- âœ… é‡æ–°è®¡ç®—æˆæœ¬ä»·
- âœ… æ‰¹é‡é‡æ–°è®¡ç®—
- âœ… è¾¹ç•Œæµ‹è¯•ï¼ˆåµŒå¥—ã€ä¸å­˜åœ¨ã€ç¼ºå°‘å­—æ®µï¼‰

## ğŸ“ å­¦ä¹ ä»·å€¼

æœ¬å®ç°å±•ç¤ºäº†ï¼š
1. **æœ€å°åŒ–æ”¹åŠ¨åŸåˆ™**ï¼šåœ¨ç°æœ‰ç³»ç»Ÿä¸Šæ‰©å±•ï¼Œè€Œä¸æ˜¯æ¨å€’é‡æ¥
2. **æ•°æ®ä¸€è‡´æ€§è®¾è®¡**ï¼šå®æ—¶ JOIN vs å¿«ç…§æ•°æ®çš„æƒè¡¡
3. **ä¸šåŠ¡é€»è¾‘åˆ†ç¦»**ï¼šè¾…åŠ©ç±»æ¨¡å¼ï¼Œä¿æŒä»£ç æ¸…æ™°
4. **çµæ´»çš„æˆæœ¬è®¡ç®—**ï¼šæ”¯æŒè‡ªå®šä¹‰å’Œè‡ªåŠ¨ä¸¤ç§æ¨¡å¼
5. **å®Œæ•´çš„é”™è¯¯å¤„ç†**ï¼š7ç§é”™è¯¯ç è¦†ç›–å„ç§å¼‚å¸¸æƒ…å†µ

---

**å®æ–½æ—¥æœŸï¼š** 2025-10-30  
**å®æ–½äººå‘˜ï¼š** AI Assistant (Claude)  
**å®¡æ ¸çŠ¶æ€ï¼š** â³ å¾…ç”¨æˆ·æµ‹è¯•éªŒè¯

**ä¸‹ä¸€æ­¥ï¼š** è¯·æŒ‰ç…§æµ‹è¯•æŒ‡å—è¿›è¡ŒåŠŸèƒ½éªŒè¯ï¼Œå¦‚æœ‰é—®é¢˜éšæ—¶åé¦ˆï¼ğŸš€

