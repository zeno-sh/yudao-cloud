<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="cn.iocoder.yudao.module.dm.dal.mysql.order.OzonOrderItemMapper">

    <!--
        一般情况下，尽可能使用 Mapper 进行 CRUD 增删改查即可。
        无法满足的场景，例如说多表关联查询，才使用 XML 编写 SQL。
        代码生成器暂时只生成 Mapper XML 文件本身，更多推荐 MybatisX 快速开发插件来生成查询。
        文档可见：https://www.iocoder.cn/MyBatis/x-plugins/
        
        重要说明：所有涉及日期时间的查询参数都是已经转换为UTC时间的LocalDateTime对象
        数据库中存储的也是UTC时间，而业务中使用的是莫斯科时区(UTC+3)的时间。
        Java代码中会将前端传来的莫斯科时区日期转换为对应的UTC时间范围后传入SQL查询。
     -->

    <!-- 按门店维度查询销量统计数据 -->
    <select id="selectShopOrderItemPage" resultType="cn.iocoder.yudao.module.dm.dal.dataobject.order.OzonOrderItemDO">
        <!-- 注意：beginDateTime和endDateTime参数是UTC时间，用于与数据库中的in_process_at字段比较 -->
        SELECT
            t.client_id,
            SUM(t.quantity) AS quantity,
            SUM(t.price) AS price
        FROM dm_ozon_order_item t
        <where>
            <if test="reqVO.clientIds != null and reqVO.clientIds.length > 0">
                t.client_id IN
                <foreach collection="reqVO.clientIds" item="clientId" open="(" separator="," close=")">
                    #{clientId}
                </foreach>
            </if>
            <if test="beginDateTime != null and endDateTime != null">
                AND t.in_process_at BETWEEN #{beginDateTime} AND #{endDateTime}
            </if>
            AND t.deleted = 0
        </where>
        GROUP BY t.client_id
        HAVING SUM(t.quantity) > 0
        ORDER BY quantity DESC
    </select>

    <!-- 按SKU维度查询销量统计数据 -->
    <select id="selectSkuOrderItemPage" resultType="cn.iocoder.yudao.module.dm.dal.dataobject.order.OzonOrderItemDO">
        <!-- 注意：beginDateTime和endDateTime参数是UTC时间，用于与数据库中的in_process_at字段比较 -->
        SELECT
            p.dm_product_id AS dmProductId,
            SUM(t.quantity) AS quantity,
            SUM(t.price) AS price
        FROM dm_ozon_order_item t
        JOIN dm_ozon_product_online p ON t.platform_sku_id = p.platform_sku_id
        <where>
            <if test="reqVO.productId != null and reqVO.productId != ''">
                p.dm_product_id = #{reqVO.productId}
            </if>
            <if test="reqVO.clientIds != null and reqVO.clientIds.length > 0">
                AND t.client_id IN
                <foreach collection="reqVO.clientIds" item="clientId" open="(" separator="," close=")">
                    #{clientId}
                </foreach>
            </if>
            AND t.in_process_at BETWEEN #{beginDateTime} AND #{endDateTime}
            AND t.deleted = 0
            AND p.deleted = 0
            AND p.dm_product_id IS NOT NULL
        </where>
        GROUP BY p.dm_product_id
        HAVING SUM(t.quantity) > 0
        ORDER BY quantity DESC
    </select>

    <!-- 查询指定月份的销售统计数据 -->
    <select id="selectMonthSalesStats" resultType="java.util.Map">
        <!-- 注意：month参数是莫斯科时区的月份，通过DATE_FORMAT转换为莫斯科当地时间 -->
        SELECT 
            i.offer_id as offerId,
            SUM(i.quantity) as salesQuantity
        FROM dm_ozon_order_item i
        WHERE i.deleted = 0
        AND DATE_FORMAT(i.in_process_at, '%Y-%m') = #{month}
        <if test="clientIds != null and clientIds.length > 0">
            AND i.client_id IN
            <foreach collection="clientIds" item="clientId" open="(" separator="," close=")">
                #{clientId}
            </foreach>
        </if>
        <if test="sku != null">
            AND i.sku = #{sku}
        </if>
        GROUP BY i.offer_id
    </select>

    <!-- 查询历史销售统计数据 -->
    <select id="selectHistorySalesStats" resultType="java.util.Map">
        <!-- 注意：month参数是莫斯科时区的月份，通过DATE_FORMAT转换为莫斯科当地时间 -->
        SELECT 
            i.offer_id as offerId,
            SUM(i.quantity) as salesQuantity
        FROM dm_ozon_order_item i
        WHERE i.deleted = 0
        AND DATE_FORMAT(i.in_process_at, '%Y-%m') &lt; #{month}
        <if test="clientIds != null and clientIds.length > 0">
            AND i.client_id IN
            <foreach collection="clientIds" item="clientId" open="(" separator="," close=")">
                #{clientId}
            </foreach>
        </if>
        <if test="sku != null">
            AND i.sku = #{sku}
        </if>
        GROUP BY i.offer_id
    </select>

    <select id="selectSkuOrderItem"
            resultType="cn.iocoder.yudao.module.dm.infrastructure.service.dto.ProductVolumeDTO">

        <!-- 注意：beginDateTime和endDateTime参数是UTC时间，用于与数据库中的in_process_at字段比较 -->
        SELECT
            p.dm_product_id AS dmProductId,
            p.platform_sku_id AS platformSkuId,
            p.client_id AS clientId,
            SUM(t.quantity) AS total
        FROM dm_ozon_order_item t
        JOIN dm_ozon_product_online p ON t.platform_sku_id = p.platform_sku_id
        <where>
            <if test="reqVO.productId != null and reqVO.productId != ''">
                p.dm_product_id = #{reqVO.productId}
            </if>
            <if test="reqVO.clientIds != null and reqVO.clientIds.length > 0">
                AND t.client_id IN
                <foreach collection="reqVO.clientIds" item="clientId" open="(" separator="," close=")">
                    #{clientId}
                </foreach>
            </if>
            AND t.in_process_at BETWEEN #{beginDateTime} AND #{endDateTime}
            AND t.deleted = 0
            AND p.deleted = 0
            AND p.dm_product_id IS NOT NULL
        </where>
        GROUP BY p.dm_product_id,p.platform_sku_id, p.client_id
    </select>

</mapper> 