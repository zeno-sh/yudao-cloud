<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="cn.iocoder.yudao.module.dm.dal.mysql.transport.TransportPlanMapper">

    <!--
        一般情况下，尽可能使用 Mapper 进行 CRUD 增删改查即可。
        无法满足的场景，例如说多表关联查询，才使用 XML 编写 SQL。
        代码生成器暂时只生成 Mapper XML 文件本身，更多推荐 MybatisX 快速开发插件来生成查询。
        文档可见：https://www.iocoder.cn/MyBatis/x-plugins/
     -->

    <!-- 查询月度发货计划报表 -->
    <select id="selectMonthlyTransportReport" resultType="cn.iocoder.yudao.module.dm.controller.admin.statistics.vo.TransportReportVO">
        SELECT t.*
        FROM (
            SELECT 
                pi.id AS product_id,
                IFNULL(h.transit_quantity, 0) - IFNULL(h2.arrival_quantity, 0) as begin_transit_quantity,
                IFNULL(c.transit_quantity, 0) as current_transit_quantity,
                IFNULL(a.arrival_quantity, 0) as current_arrival_quantity,
                IFNULL(h.transit_quantity, 0) - IFNULL(h2.arrival_quantity, 0) + IFNULL(c.transit_quantity, 0)
                   - IFNULL(a.arrival_quantity, 0) as end_transit_quantity
            FROM dm_product_info pi
            LEFT JOIN (
                SELECT tpi.product_id, SUM(tpi.quantity) as transit_quantity
                FROM dm_transport_plan_item tpi
                INNER JOIN dm_transport_plan tp ON tpi.plan_id = tp.id AND tp.deleted = 0 
                WHERE tpi.deleted = 0
                    AND tp.despatch_date &lt; #{startDate}
                GROUP BY tpi.product_id
            ) h ON pi.id = h.product_id
            LEFT JOIN (
                SELECT tpi.product_id, SUM(tpi.quantity) as arrival_quantity
                FROM dm_transport_plan_item tpi
                INNER JOIN dm_transport_plan tp ON tpi.plan_id = tp.id AND tp.deleted = 0
                WHERE tpi.deleted = 0
                    AND tp.transport_status = 40
                    AND tp.finished_date &lt; #{startDate}
                GROUP BY tpi.product_id
            ) h2 ON pi.id = h2.product_id
            LEFT JOIN (
                SELECT tpi.product_id, SUM(tpi.quantity) as transit_quantity
                FROM dm_transport_plan_item tpi
                INNER JOIN dm_transport_plan tp ON tpi.plan_id = tp.id AND tp.deleted = 0 
                WHERE tpi.deleted = 0
                    AND tp.despatch_date BETWEEN #{startDate} AND #{endDate}
                GROUP BY tpi.product_id
            ) c ON pi.id = c.product_id
            LEFT JOIN (
                SELECT tpi.product_id, SUM(tpi.quantity) as arrival_quantity
                FROM dm_transport_plan_item tpi
                INNER JOIN dm_transport_plan tp ON tpi.plan_id = tp.id AND tp.deleted = 0 
                WHERE tpi.deleted = 0
                    AND tp.transport_status = 40
                    AND tp.finished_date BETWEEN #{startDate} AND #{endDate}
                GROUP BY tpi.product_id
            ) a ON pi.id = a.product_id
            WHERE pi.deleted = 0
            <if test="productId != null">
                AND pi.id = #{productId}
            </if>
        ) t
        WHERE NOT (
            t.begin_transit_quantity = 0
            AND t.current_transit_quantity = 0
            AND t.current_arrival_quantity = 0
            AND t.end_transit_quantity = 0
        )
        ORDER BY t.end_transit_quantity DESC, t.product_id DESC
    </select>

    <select id="selectTransportPlanDetailList" resultType="cn.iocoder.yudao.module.dm.dal.dataobject.transport.TransportPlanDetailDTO">
        SELECT
            tpi.*,
            tp.despatch_date,
            tp.arrival_date,
            tp.finished_date,
            tp.forwarder,
            tp.code,
            tp.transport_status
        FROM dm_transport_plan_item tpi
        LEFT JOIN dm_transport_plan tp ON tp.id = tpi.plan_id
        <where>
            <if test="reqVO.productIds != null and reqVO.productIds.size() > 0">
                AND tpi.product_id IN
                <foreach collection="reqVO.productIds" item="productId" open="(" separator="," close=")">
                    #{productId}
                </foreach>
            </if>
            <if test="reqVO.transportStatus != null and reqVO.transportStatus.size() > 0">
                AND tp.transport_status IN
                <foreach collection="reqVO.transportStatus" item="status" open="(" separator="," close=")">
                    #{status}
                </foreach>
            </if>
            <if test="reqVO.overseaLocationCheckinIds != null and reqVO.overseaLocationCheckinIds.size() > 0">
                AND tpi.oversea_location_checkin_id IN
                <foreach collection="reqVO.overseaLocationCheckinIds" item="checkinId" open="(" separator="," close=")">
                    #{checkinId}
                </foreach>
            </if>
            AND tpi.deleted = 0
            AND tp.deleted = 0
        </where>
        ORDER BY tp.finished_date DESC, tp.despatch_date DESC,tpi.product_id DESC
    </select>

</mapper>