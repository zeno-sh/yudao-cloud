# 海外仓服务技术方案

## 1. 项目概述

### 1.1 背景
跨境电商ERP系统需要对接多个海外仓系统（易仓、领星、乐歌等），实现海外仓授权、产品同步、库存同步、账单同步等功能，并为其他微服务提供标准化的海外仓操作接口。

### 1.2 目标
- 建立标准化的海外仓对接规范（SPI接口）
- 提供统一的RPC服务接口供其他微服务调用
- 支持多海外仓系统的动态加载和路由
- 实现海外仓业务的统一管理和监控

## 2. 架构设计

### 2.1 整体架构
```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   订单模块      │    │   库存模块      │    │   其他模块      │
└─────────────────┘    └─────────────────┘    └─────────────────┘
         │                       │                       │
         └───────────────────────┼───────────────────────┘
                                 │ RPC调用
                                 ▼
         ┌─────────────────────────────────────────────────────┐
         │              海外仓服务 (Warehouse Service)          │
         │  ┌─────────────────┐    ┌─────────────────────────┐  │
         │  │   RPC接口层     │    │      业务服务层        │  │
         │  └─────────────────┘    └─────────────────────────┘  │
         │                                   │                 │
         │                                   ▼                 │
         │  ┌─────────────────────────────────────────────────┐  │
         │  │              SPI接口层                         │  │
         │  └─────────────────────────────────────────────────┘  │
         └─────────────────────────────────────────────────────┘
                                 │
         ┌───────────────────────┼───────────────────────┐
         │                       │                       │
         ▼                       ▼                       ▼
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   易仓适配器    │    │   领星适配器    │    │   乐歌适配器    │
└─────────────────┘    └─────────────────┘    └─────────────────┘
```

### 2.2 模块结构
```
yudao-module-warehouse/
├── yudao-module-warehouse-api/          # API接口层
│   ├── src/main/java/cn/iocoder/yudao/module/warehouse/
│   │   ├── api/                         # RPC接口定义
│   │   ├── dto/                         # 数据传输对象
│   │   ├── enums/                       # 枚举定义
│   │   └── spi/                         # SPI接口定义
│   └── pom.xml
├── yudao-module-warehouse-server/       # 服务实现层
│   ├── src/main/java/cn/iocoder/yudao/module/warehouse/
│   │   ├── service/                     # 业务服务层
│   │   ├── rpc/                         # RPC实现层
│   │   ├── infrastructure/              # 基础设施层
│   │   │   ├── adapter/                 # 适配器实现
│   │   │   │   ├── yicang/              # 易仓适配器
│   │   │   │   ├── lingxing/            # 领星适配器
│   │   │   │   ├── lege/                # 乐歌适配器
│   │   │   │   └── common/              # 通用组件
│   │   │   ├── config/                  # 配置管理
│   │   │   ├── factory/                 # 适配器工厂
│   │   │   └── exception/               # 异常处理
│   │   └── dal/                         # 数据访问层
│   └── pom.xml
└── pom.xml
```

## 3. SPI接口设计

### 3.1 核心SPI接口定义

#### 3.1.1 海外仓适配器主接口
```java
/**
 * 海外仓适配器接口
 * 每个海外仓系统需要实现此接口
 */
public interface WarehouseAdapter {
    
    /**
     * 获取适配器类型
     * @return 海外仓系统代号 (YICANG, LINGXING, LEGE等)
     */
    WarehouseTypeEnum getWarehouseType();
    
    /**
     * 获取授权服务
     */
    WarehouseAuthSpi getAuthSpi();
    
    /**
     * 获取产品服务
     */
    WarehouseProductSpi getProductSpi();
    
    /**
     * 获取库存服务
     */
    WarehouseInventorySpi getInventorySpi();
    
    /**
     * 获取账单服务
     */
    WarehouseBillSpi getBillSpi();
    
    /**
     * 获取数据服务
     */
    WarehouseDataSpi getDataSpi();
    
    /**
     * 适配器初始化
     */
    void initialize(WarehouseConfig config);
    
    /**
     * 健康检查
     */
    boolean healthCheck();
}
```

#### 3.1.2 授权SPI接口
```java
/**
 * 海外仓授权SPI接口
 */
public interface WarehouseAuthSpi {
    
    /**
     * 获取授权URL
     */
    String getAuthUrl(AuthUrlRequest request);
    
    /**
     * 完成授权，获取访问令牌
     */
    AuthResult completeAuth(AuthCompleteRequest request);
    
    /**
     * 刷新访问令牌
     */
    AuthResult refreshToken(RefreshTokenRequest request);
    
    /**
     * 验证令牌有效性
     */
    AuthValidateResult validateToken(AuthValidateRequest request);
    
    /**
     * 撤销授权
     */
    boolean revokeAuth(AuthRevokeRequest request);
}
```

#### 3.1.3 产品SPI接口
```java
/**
 * 海外仓产品SPI接口
 */
public interface WarehouseProductSpi {
    
    /**
     * 获取产品信息
     */
    ProductInfo getProduct(ProductGetRequest request);
    
    /**
     * 批量获取产品信息
     */
    List<ProductInfo> batchGetProducts(ProductBatchGetRequest request);
    
    /**
     * 同步产品到海外仓
     */
    ProductSyncResult syncProduct(ProductSyncRequest request);
    
    /**
     * 批量同步产品
     */
    List<ProductSyncResult> batchSyncProducts(ProductBatchSyncRequest request);
    
    /**
     * 更新产品信息
     */
    ProductUpdateResult updateProduct(ProductUpdateRequest request);
    
    /**
     * 删除产品
     */
    boolean deleteProduct(ProductDeleteRequest request);
    
    /**
     * 获取产品列表
     */
    ProductListResult getProductList(ProductListRequest request);
    
    /**
     * 获取产品同步状态
     */
    ProductSyncStatus getSyncStatus(ProductSyncStatusRequest request);
}
```

#### 3.1.4 库存SPI接口
```java
/**
 * 海外仓库存SPI接口
 */
public interface WarehouseInventorySpi {
    
    /**
     * 获取库存信息
     */
    InventoryInfo getInventory(InventoryGetRequest request);
    
    /**
     * 批量获取库存信息
     */
    List<InventoryInfo> batchGetInventory(InventoryBatchGetRequest request);
    
    /**
     * 同步库存变更
     */
    InventorySyncResult syncInventoryChange(InventoryChangeRequest request);
    
    /**
     * 获取库存变更历史
     */
    List<InventoryChangeRecord> getInventoryHistory(InventoryHistoryRequest request);
    
    /**
     * 设置库存预警
     */
    boolean setInventoryAlert(InventoryAlertRequest request);
    
    /**
     * 获取库存预警列表
     */
    List<InventoryAlert> getInventoryAlerts(InventoryAlertQueryRequest request);
    
    /**
     * 获取库存统计信息
     */
    InventoryStats getInventoryStats(InventoryStatsRequest request);
}
```

#### 3.1.5 账单SPI接口
```java
/**
 * 海外仓账单SPI接口
 */
public interface WarehouseBillSpi {
    
    /**
     * 获取账单列表
     */
    BillListResult getBillList(BillListRequest request);
    
    /**
     * 获取账单详情
     */
    BillDetail getBillDetail(BillDetailRequest request);
    
    /**
     * 同步账单数据
     */
    BillSyncResult syncBills(BillSyncRequest request);
    
    /**
     * 获取费用明细
     */
    List<FeeDetail> getFeeDetails(FeeDetailRequest request);
    
    /**
     * 下载账单文件
     */
    BillFileResult downloadBillFile(BillFileRequest request);
    
    /**
     * 获取账单统计
     */
    BillStats getBillStats(BillStatsRequest request);
}
```

#### 3.1.6 数据展示SPI接口
```java
/**
 * 海外仓数据展示SPI接口
 */
public interface WarehouseDataSpi {
    
    /**
     * 获取仓库概览数据
     */
    WarehouseOverview getWarehouseOverview(OverviewRequest request);
    
    /**
     * 获取库存统计数据
     */
    InventoryStats getInventoryStats(StatsRequest request);
    
    /**
     * 获取费用统计数据
     */
    CostStats getCostStats(CostStatsRequest request);
    
    /**
     * 获取运营报表数据
     */
    OperationReport getOperationReport(ReportRequest request);
    
    /**
     * 获取趋势分析数据
     */
    TrendAnalysis getTrendAnalysis(TrendRequest request);
    
    /**
     * 获取实时数据
     */
    RealTimeData getRealTimeData(RealTimeDataRequest request);
}
```

### 3.2 海外仓系统枚举
```java
/**
 * 海外仓系统类型枚举
 */
public enum WarehouseTypeEnum {
    
    YICANG("yicang", "易仓"),
    LINGXING("lingxing", "领星"),
    LEGE("lege", "乐歌"),
    AMAZON_FBA("amazon_fba", "亚马逊FBA"),
    SHOPIFY("shopify", "Shopify"),
    RAKUTEN("rakuten", "乐天");
    
    private final String code;
    private final String name;
    
    WarehouseTypeEnum(String code, String name) {
        this.code = code;
        this.name = name;
    }
    
    public String getCode() {
        return code;
    }
    
    public String getName() {
        return name;
    }
    
    public static WarehouseTypeEnum fromCode(String code) {
        for (WarehouseTypeEnum type : values()) {
            if (type.code.equals(code)) {
                return type;
            }
        }
        throw new IllegalArgumentException("未知的海外仓系统代号: " + code);
    }
}
```

## 4. 适配器工厂和路由机制

### 4.1 适配器工厂设计
```java
/**
 * 海外仓适配器工厂
 * 负责管理和路由不同的海外仓适配器
 */
@Component
public class WarehouseAdapterFactory implements InitializingBean {
    
    /**
     * 适配器注册表
     * Key: 海外仓系统代号
     * Value: 适配器实例
     */
    private final Map<String, WarehouseAdapter> adapterRegistry = new ConcurrentHashMap<>();
    
    @Autowired
    private WarehouseConfigManager configManager;
    
    @Autowired
    private List<WarehouseAdapter> adapters;
    
    /**
     * 初始化适配器工厂
     */
    @Override
    public void afterPropertiesSet() throws Exception {
        initializeAdapters();
    }
    
    /**
     * 初始化所有适配器
     */
    private void initializeAdapters() {
        for (WarehouseAdapter adapter : adapters) {
            try {
                WarehouseTypeEnum type = adapter.getWarehouseType();
                String code = type.getCode();
                
                // 获取配置
                WarehouseConfig config = configManager.getConfig(code);
                if (config == null) {
                    continue;
                }
                
                // 初始化适配器
                adapter.initialize(config);
                
                // 健康检查
                if (adapter.healthCheck()) {
                    adapterRegistry.put(code, adapter);
                }
                
            } catch (Exception e) {
                // 记录错误日志
            }
        }
    }
    
    /**
     * 获取指定类型的适配器
     */
    public WarehouseAdapter getAdapter(String warehouseType) {
        WarehouseAdapter adapter = adapterRegistry.get(warehouseType);
        if (adapter == null) {
            throw new WarehouseException("未找到海外仓适配器: " + warehouseType);
        }
        return adapter;
    }
    
    /**
     * 获取所有可用的适配器
     */
    public List<WarehouseAdapter> getAllAdapters() {
        return new ArrayList<>(adapterRegistry.values());
    }
    
    /**
     * 检查指定类型的适配器是否可用
     */
    public boolean isAdapterAvailable(String warehouseType) {
        return adapterRegistry.containsKey(warehouseType);
    }
}
```

### 4.2 适配器路由服务
```java
/**
 * 海外仓适配器路由服务
 * 提供统一的适配器调用入口
 */
@Service
public class WarehouseAdapterRouter {
    
    @Autowired
    private WarehouseAdapterFactory adapterFactory;
    
    /**
     * 路由到指定的授权服务
     */
    public WarehouseAuthSpi routeToAuthSpi(String warehouseType) {
        return adapterFactory.getAdapter(warehouseType).getAuthSpi();
    }
    
    /**
     * 路由到指定的产品服务
     */
    public WarehouseProductSpi routeToProductSpi(String warehouseType) {
        return adapterFactory.getAdapter(warehouseType).getProductSpi();
    }
    
    /**
     * 路由到指定的库存服务
     */
    public WarehouseInventorySpi routeToInventorySpi(String warehouseType) {
        return adapterFactory.getAdapter(warehouseType).getInventorySpi();
    }
    
    /**
     * 路由到指定的账单服务
     */
    public WarehouseBillSpi routeToBillSpi(String warehouseType) {
        return adapterFactory.getAdapter(warehouseType).getBillSpi();
    }
    
    /**
     * 路由到指定的数据服务
     */
    public WarehouseDataSpi routeToDataSpi(String warehouseType) {
        return adapterFactory.getAdapter(warehouseType).getDataSpi();
    }
}
```

## 5. RPC接口设计

### 5.1 产品相关RPC接口
```java
/**
 * 海外仓产品RPC接口
 */
@FeignClient(name = WarehouseConstants.NAME)
@Tag(name = "RPC 服务 - 海外仓产品")
public interface WarehouseProductApi {
    
    String PREFIX = WarehouseConstants.PREFIX + "/product";
    
    /**
     * 查询产品信息
     */
    @GetMapping(PREFIX + "/get")
    @Operation(summary = "查询产品信息")
    CommonResult<WarehouseProductDTO> getProduct(
            @RequestParam("productId") String productId,
            @RequestParam("warehouseType") String warehouseType);
    
    /**
     * 批量查询产品信息
     */
    @PostMapping(PREFIX + "/batch-get")
    @Operation(summary = "批量查询产品信息")
    CommonResult<List<WarehouseProductDTO>> batchGetProducts(
            @RequestBody ProductBatchQueryDTO request);
    
    /**
     * 同步产品到海外仓
     */
    @PostMapping(PREFIX + "/sync")
    @Operation(summary = "同步产品到海外仓")
    CommonResult<ProductSyncResultDTO> syncProduct(
            @RequestBody ProductSyncRequestDTO request);
    
    /**
     * 跨海外仓查询产品映射
     */
    @PostMapping(PREFIX + "/cross-warehouse-mapping")
    @Operation(summary = "跨海外仓查询产品映射")
    CommonResult<Map<String, WarehouseProductDTO>> getCrossWarehouseMapping(
            @RequestBody CrossWarehouseQueryDTO request);
}
```

### 5.2 库存相关RPC接口
```java
/**
 * 海外仓库存RPC接口
 */
@FeignClient(name = WarehouseConstants.NAME)
@Tag(name = "RPC 服务 - 海外仓库存")
public interface WarehouseInventoryApi {
    
    String PREFIX = WarehouseConstants.PREFIX + "/inventory";
    
    /**
     * 查询库存信息
     */
    @GetMapping(PREFIX + "/get")
    @Operation(summary = "查询库存信息")
    CommonResult<InventoryInfoDTO> getInventory(
            @RequestParam("productId") String productId,
            @RequestParam("warehouseId") String warehouseId,
            @RequestParam("warehouseType") String warehouseType);
    
    /**
     * 批量查询库存
     */
    @PostMapping(PREFIX + "/batch-get")
    @Operation(summary = "批量查询库存")
    CommonResult<List<InventoryInfoDTO>> batchGetInventory(
            @RequestBody InventoryBatchQueryDTO request);
    
    /**
     * 跨海外仓库存汇总
     */
    @PostMapping(PREFIX + "/cross-warehouse-summary")
    @Operation(summary = "跨海外仓库存汇总")
    CommonResult<InventorySummaryDTO> getCrossWarehouseInventorySummary(
            @RequestBody InventorySummaryRequestDTO request);
}
```

## 6. 具体适配器实现示例

### 6.1 易仓适配器实现
```java
/**
 * 易仓海外仓适配器实现
 */
@Component
public class YicangWarehouseAdapter implements WarehouseAdapter {
    
    private WarehouseConfig config;
    private YicangAuthSpi authSpi;
    private YicangProductSpi productSpi;
    private YicangInventorySpi inventorySpi;
    private YicangBillSpi billSpi;
    private YicangDataSpi dataSpi;
    
    @Override
    public WarehouseTypeEnum getWarehouseType() {
        return WarehouseTypeEnum.YICANG;
    }
    
    @Override
    public void initialize(WarehouseConfig config) {
        this.config = config;
        // 初始化各个SPI实现
        this.authSpi = new YicangAuthSpiImpl(config);
        this.productSpi = new YicangProductSpiImpl(config);
        this.inventorySpi = new YicangInventorySpiImpl(config);
        this.billSpi = new YicangBillSpiImpl(config);
        this.dataSpi = new YicangDataSpiImpl(config);
    }
    
    @Override
    public boolean healthCheck() {
        try {
            // 调用易仓API进行健康检查
            return authSpi.validateToken(new AuthValidateRequest()).isValid();
        } catch (Exception e) {
            return false;
        }
    }
    
    // 其他方法实现...
}
```

## 7. 数据库设计

### 7.1 海外仓系统配置表
```sql
-- 海外仓系统配置表
CREATE TABLE `mpro_warehouse_system_config` (
  `id` bigint NOT NULL AUTO_INCREMENT COMMENT '主键ID',
  `system_code` varchar(50) NOT NULL COMMENT '系统代号(yicang,lingxing,lege等)',
  `system_name` varchar(100) NOT NULL COMMENT '系统名称',
  `system_type` tinyint NOT NULL DEFAULT 10 COMMENT '系统类型(10:海外仓,20:FBA,30:第三方物流)',
  `api_base_url` varchar(500) NOT NULL COMMENT 'API基础地址',
  `auth_type` tinyint NOT NULL DEFAULT 10 COMMENT '授权类型(10:API_KEY,20:OAUTH2,30:TOKEN)',
  `status` tinyint NOT NULL DEFAULT 10 COMMENT '状态(10:禁用,20:启用)',
  `config_json` json DEFAULT NULL COMMENT '系统特殊配置(JSON格式)',
  `remark` text DEFAULT NULL COMMENT '备注',
  `deleted` bit(1) NOT NULL DEFAULT b'0' COMMENT '是否删除',
  `tenant_id` bigint NOT NULL DEFAULT 0 COMMENT '租户ID',
  `creator` varchar(64) DEFAULT NULL COMMENT '创建者',
  `create_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `updater` varchar(64) DEFAULT NULL COMMENT '更新者',
  `update_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_system_code_tenant` (`system_code`,`tenant_id`,`deleted`),
  KEY `idx_system_type` (`system_type`),
  KEY `idx_status` (`status`),
  KEY `idx_tenant_id` (`tenant_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='海外仓系统配置表';
```

### 7.2 海外仓授权信息表
```sql
-- 海外仓授权信息表
CREATE TABLE `mpro_warehouse_auth_info` (
  `id` bigint NOT NULL AUTO_INCREMENT COMMENT '主键ID',
  `system_config_id` bigint NOT NULL COMMENT '系统配置ID',
  `auth_name` varchar(100) NOT NULL COMMENT '授权名称',
  `shop_id` varchar(100) DEFAULT NULL COMMENT '店铺ID',
  `shop_name` varchar(200) DEFAULT NULL COMMENT '店铺名称',
  `client_id` varchar(255) DEFAULT NULL COMMENT '客户端ID',
  `client_secret` varchar(500) DEFAULT NULL COMMENT '客户端密钥',
  `api_key` varchar(500) DEFAULT NULL COMMENT 'API密钥',
  `api_secret` varchar(500) DEFAULT NULL COMMENT 'API密钥',
  `access_token` text DEFAULT NULL COMMENT '访问令牌',
  `refresh_token` text DEFAULT NULL COMMENT '刷新令牌',
  `token_type` varchar(50) DEFAULT NULL COMMENT '令牌类型(Bearer等)',
  `scope` varchar(500) DEFAULT NULL COMMENT '授权范围',
  `auth_status` tinyint NOT NULL DEFAULT 10 COMMENT '授权状态(10:未授权,20:已授权,30:已过期,40:已撤销)',
  `auth_time` datetime DEFAULT NULL COMMENT '授权时间',
  `expire_time` datetime DEFAULT NULL COMMENT '过期时间',
  `last_refresh_time` datetime DEFAULT NULL COMMENT '最后刷新时间',
  `extra_params` json DEFAULT NULL COMMENT '额外参数(JSON格式)',
  `error_message` text DEFAULT NULL COMMENT '错误信息',
  `retry_count` int NOT NULL DEFAULT 0 COMMENT '重试次数',
  `last_check_time` datetime DEFAULT NULL COMMENT '最后检查时间',
  `deleted` bit(1) NOT NULL DEFAULT b'0' COMMENT '是否删除',
  `tenant_id` bigint NOT NULL DEFAULT 0 COMMENT '租户ID',
  `creator` varchar(64) DEFAULT NULL COMMENT '创建者',
  `create_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `updater` varchar(64) DEFAULT NULL COMMENT '更新者',
  `update_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  KEY `idx_system_config_id` (`system_config_id`),
  KEY `idx_shop_id` (`shop_id`),
  KEY `idx_auth_status` (`auth_status`),
  KEY `idx_expire_time` (`expire_time`),
  KEY `idx_tenant_id` (`tenant_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='海外仓授权信息表';
```

### 7.3 海外仓授权日志表
```sql
-- 海外仓授权日志表
CREATE TABLE `mpro_warehouse_auth_log` (
  `id` bigint NOT NULL AUTO_INCREMENT COMMENT '主键ID',
  `auth_info_id` bigint NOT NULL COMMENT '授权信息ID',
  `operation_type` tinyint NOT NULL COMMENT '操作类型(10:授权,20:刷新,30:撤销,40:验证)',
  `operation_status` tinyint NOT NULL COMMENT '操作状态(10:失败,20:成功)',
  `request_data` text DEFAULT NULL COMMENT '请求数据',
  `response_data` text DEFAULT NULL COMMENT '响应数据',
  `error_code` varchar(50) DEFAULT NULL COMMENT '错误码',
  `error_message` text DEFAULT NULL COMMENT '错误信息',
  `operation_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '操作时间',
  `cost_time` int DEFAULT NULL COMMENT '耗时(毫秒)',
  `ip_address` varchar(50) DEFAULT NULL COMMENT 'IP地址',
  `user_agent` varchar(500) DEFAULT NULL COMMENT '用户代理',
  `tenant_id` bigint NOT NULL DEFAULT 0 COMMENT '租户ID',
  `creator` varchar(64) DEFAULT NULL COMMENT '创建者',
  PRIMARY KEY (`id`),
  KEY `idx_auth_info_id` (`auth_info_id`),
  KEY `idx_operation_type` (`operation_type`),
  KEY `idx_operation_time` (`operation_time`),
  KEY `idx_tenant_id` (`tenant_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='海外仓授权日志表';
```

### 7.4 海外仓产品映射表
```sql
-- 海外仓产品映射表
CREATE TABLE `mpro_warehouse_product_mapping` (
  `id` bigint NOT NULL AUTO_INCREMENT COMMENT '主键ID',
  `auth_info_id` bigint NOT NULL COMMENT '授权信息ID',
  `local_product_id` varchar(100) NOT NULL COMMENT '本地产品ID',
  `local_sku` varchar(200) NOT NULL COMMENT '本地SKU',
  `warehouse_product_id` varchar(100) DEFAULT NULL COMMENT '海外仓产品ID',
  `warehouse_sku` varchar(200) DEFAULT NULL COMMENT '海外仓SKU',
  `mapping_status` tinyint NOT NULL DEFAULT 10 COMMENT '映射状态(10:未映射,20:已映射,30:映射失败)',
  `sync_status` tinyint NOT NULL DEFAULT 10 COMMENT '同步状态(10:未同步,20:同步中,30:同步成功,40:同步失败)',
  `last_sync_time` datetime DEFAULT NULL COMMENT '最后同步时间',
  `sync_error_message` text DEFAULT NULL COMMENT '同步错误信息',
  `extra_data` json DEFAULT NULL COMMENT '额外数据(JSON格式)',
  `deleted` bit(1) NOT NULL DEFAULT b'0' COMMENT '是否删除',
  `tenant_id` bigint NOT NULL DEFAULT 0 COMMENT '租户ID',
  `creator` varchar(64) DEFAULT NULL COMMENT '创建者',
  `create_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `updater` varchar(64) DEFAULT NULL COMMENT '更新者',
  `update_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_auth_local_product` (`auth_info_id`,`local_product_id`,`deleted`),
  KEY `idx_local_sku` (`local_sku`),
  KEY `idx_warehouse_sku` (`warehouse_sku`),
  KEY `idx_mapping_status` (`mapping_status`),
  KEY `idx_sync_status` (`sync_status`),
  KEY `idx_tenant_id` (`tenant_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='海外仓产品映射表';
```

### 7.5 海外仓仓库信息表
```sql
-- 海外仓仓库信息表
CREATE TABLE `mpro_warehouse_info` (
  `id` bigint NOT NULL AUTO_INCREMENT COMMENT '主键ID',
  `auth_info_id` bigint NOT NULL COMMENT '授权信息ID',
  `warehouse_name` varchar(255) NOT NULL COMMENT '仓库名称',
  `warehouse_code` varchar(100) DEFAULT NULL COMMENT '仓库代码',
  `platform_warehouse_id` varchar(100) DEFAULT NULL COMMENT '平台仓库ID',
  `country` varchar(100) DEFAULT NULL COMMENT '国家',
  `city` varchar(100) NOT NULL COMMENT '城市',
  `address` varchar(1000) NOT NULL COMMENT '详细地址',
  `contact_person` varchar(100) NOT NULL COMMENT '联系人',
  `phone` varchar(20) NOT NULL COMMENT '联系电话',
  `email` varchar(100) DEFAULT NULL COMMENT '联系邮箱',
  `time_zone` varchar(50) DEFAULT NULL COMMENT '时区',
  `currency` varchar(10) DEFAULT NULL COMMENT '货币单位',
  `volumetric_weight_factor` int DEFAULT NULL COMMENT '体积重量系数',
  `warehouse_type` tinyint NOT NULL DEFAULT 10 COMMENT '仓库类型(10:自营仓,20:第三方仓,30:FBA仓)',
  `status` tinyint NOT NULL DEFAULT 20 COMMENT '状态(10:禁用,20:启用,30:维护中)',
  `extra_config` json DEFAULT NULL COMMENT '额外配置(JSON格式)',
  `remark` text DEFAULT NULL COMMENT '备注',
  `deleted` bit(1) NOT NULL DEFAULT b'0' COMMENT '是否删除',
  `tenant_id` bigint NOT NULL DEFAULT 0 COMMENT '租户ID',
  `creator` varchar(64) DEFAULT NULL COMMENT '创建者',
  `create_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `updater` varchar(64) DEFAULT NULL COMMENT '更新者',
  `update_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  KEY `idx_auth_info_id` (`auth_info_id`),
  KEY `idx_warehouse_code` (`warehouse_code`),
  KEY `idx_platform_warehouse_id` (`platform_warehouse_id`),
  KEY `idx_city` (`city`),
  KEY `idx_status` (`status`),
  KEY `idx_tenant_id` (`tenant_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='海外仓仓库信息表';
```

### 7.6 海外仓库存记录表
```sql
-- 海外仓库存记录表
CREATE TABLE `mpro_warehouse_inventory_record` (
  `id` bigint NOT NULL AUTO_INCREMENT COMMENT '主键ID',
  `warehouse_info_id` bigint NOT NULL COMMENT '仓库信息ID',
  `product_mapping_id` bigint NOT NULL COMMENT '产品映射ID',
  `available_quantity` int NOT NULL DEFAULT 0 COMMENT '可用库存',
  `reserved_quantity` int NOT NULL DEFAULT 0 COMMENT '预留库存',
  `total_quantity` int NOT NULL DEFAULT 0 COMMENT '总库存',
  `inbound_quantity` int NOT NULL DEFAULT 0 COMMENT '入库数量',
  `outbound_quantity` int NOT NULL DEFAULT 0 COMMENT '出库数量',
  `unit_cost` decimal(10,4) DEFAULT NULL COMMENT '单位成本',
  `currency` varchar(10) DEFAULT NULL COMMENT '货币单位',
  `last_update_time` datetime DEFAULT NULL COMMENT '最后更新时间',
  `sync_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '同步时间',
  `tenant_id` bigint NOT NULL DEFAULT 0 COMMENT '租户ID',
  `creator` varchar(64) DEFAULT NULL COMMENT '创建者',
  `create_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_warehouse_product` (`warehouse_info_id`,`product_mapping_id`),
  KEY `idx_warehouse_info_id` (`warehouse_info_id`),
  KEY `idx_product_mapping_id` (`product_mapping_id`),
  KEY `idx_sync_time` (`sync_time`),
  KEY `idx_tenant_id` (`tenant_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='海外仓库存记录表';
```

### 7.7 初始化数据
```sql
-- 初始化海外仓系统配置数据
INSERT INTO `mpro_warehouse_system_config` (`system_code`, `system_name`, `system_type`, `api_base_url`, `auth_type`, `status`, `config_json`, `remark`) VALUES
('yicang', '易仓', 10, 'https://api.yicang.com', 20, 20, '{"timeout": 30000, "retryTimes": 3}', '易仓海外仓系统'),
('lingxing', '领星', 10, 'https://api.lingxing.com', 20, 20, '{"timeout": 30000, "retryTimes": 3}', '领星海外仓系统'),
('lege', '乐歌', 10, 'https://api.lege.com', 10, 20, '{"timeout": 30000, "retryTimes": 3}', '乐歌海外仓系统'),
('amazon_fba', '亚马逊FBA', 20, 'https://sellingpartnerapi-na.amazon.com', 20, 20, '{"timeout": 30000, "retryTimes": 3}', '亚马逊FBA'),
('shopify', 'Shopify', 10, 'https://api.shopify.com', 20, 20, '{"timeout": 30000, "retryTimes": 3}', 'Shopify海外仓'),
('rakuten', '乐天', 10, 'https://api.rakuten.com', 20, 20, '{"timeout": 30000, "retryTimes": 3}', '乐天海外仓');
```

## 8. 配置管理

### 8.1 配置结构
```yaml
warehouse:
  configs:
    yicang:
      type: yicang
      apiUrl: https://api.yicang.com
      clientId: ${YICANG_CLIENT_ID}
      clientSecret: ${YICANG_CLIENT_SECRET}
      timeout: 30000
      retryTimes: 3
    lingxing:
      type: lingxing
      apiUrl: https://api.lingxing.com
      clientId: ${LINGXING_CLIENT_ID}
      clientSecret: ${LINGXING_CLIENT_SECRET}
      timeout: 30000
      retryTimes: 3
    lege:
      type: lege
      apiUrl: https://api.lege.com
      clientId: ${LEGE_CLIENT_ID}
      clientSecret: ${LEGE_CLIENT_SECRET}
      timeout: 30000
      retryTimes: 3
```

### 8.2 配置管理器
```java
@Component
@ConfigurationProperties(prefix = "warehouse")
public class WarehouseConfigManager {
    
    private Map<String, WarehouseConfig> configs = new HashMap<>();
    
    public WarehouseConfig getConfig(String warehouseType) {
        return configs.get(warehouseType);
    }
    
    public void setConfigs(Map<String, WarehouseConfig> configs) {
        this.configs = configs;
    }
    
    public Map<String, WarehouseConfig> getConfigs() {
        return configs;
    }
}
```

### 8.3 枚举定义
```java
/**
 * 海外仓系统类型枚举
 */
public enum WarehouseSystemTypeEnum {
    
    WAREHOUSE(10, "海外仓"),
    FBA(20, "FBA"),
    THIRD_PARTY_LOGISTICS(30, "第三方物流");
    
    private final Integer code;
    private final String name;
    
    WarehouseSystemTypeEnum(Integer code, String name) {
        this.code = code;
        this.name = name;
    }
    
    public Integer getCode() {
        return code;
    }
    
    public String getName() {
        return name;
    }
}

/**
 * 授权类型枚举
 */
public enum AuthTypeEnum {
    
    API_KEY(10, "API_KEY"),
    OAUTH2(20, "OAUTH2"),
    TOKEN(30, "TOKEN");
    
    private final Integer code;
    private final String name;
    
    AuthTypeEnum(Integer code, String name) {
        this.code = code;
        this.name = name;
    }
    
    public Integer getCode() {
        return code;
    }
    
    public String getName() {
        return name;
    }
}

/**
 * 授权状态枚举
 */
public enum AuthStatusEnum {
    
    UNAUTHORIZED(10, "未授权"),
    AUTHORIZED(20, "已授权"),
    EXPIRED(30, "已过期"),
    REVOKED(40, "已撤销");
    
    private final Integer code;
    private final String name;
    
    AuthStatusEnum(Integer code, String name) {
        this.code = code;
        this.name = name;
    }
    
    public Integer getCode() {
        return code;
    }
    
    public String getName() {
        return name;
    }
}
```

## 9. 实施计划

### 9.1 第一阶段：基础架构搭建
1. 创建海外仓模块结构
2. 定义核心SPI接口
3. 实现适配器工厂和路由机制
4. 建立配置管理体系

### 9.2 第二阶段：首个适配器实现
1. 选择易仓作为首个对接系统
2. 实现易仓适配器的完整功能
3. 完善异常处理和监控
4. 编写单元测试和集成测试

### 9.3 第三阶段：多适配器扩展
1. 实现领星、乐歌等其他适配器
2. 优化跨海外仓业务功能
3. 完善数据统计和报表功能
4. 性能优化和稳定性提升

## 10. 技术选型

### 10.1 核心技术栈
- **框架**: Spring Boot 2.7.x
- **微服务**: Spring Cloud
- **RPC通信**: OpenFeign
- **HTTP客户端**: OkHttp
- **序列化**: Jackson
- **缓存**: Redis
- **消息队列**: RabbitMQ
- **数据库**: MySQL + MyBatis-Plus

### 10.2 监控和运维
- **链路追踪**: SkyWalking
- **指标监控**: Micrometer + Prometheus
- **日志**: Logback + ELK
- **健康检查**: Spring Boot Actuator

## 11. 总结

本技术方案通过SPI接口实现了海外仓系统的标准化对接，通过适配器工厂实现了多系统的动态加载和路由，通过RPC接口为其他微服务提供了统一的海外仓操作能力。

**核心优势：**
- **高扩展性**: 新增海外仓系统只需实现SPI接口
- **高可用性**: 支持多适配器并行工作，单点故障不影响整体
- **高性能**: 直接SPI调用和业务层封装相结合
- **易维护**: 清晰的分层架构，职责明确
- **标准化**: 统一的接口规范，降低对接成本
